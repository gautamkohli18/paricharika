<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡§™‡§∞‡§ø‡§ö‡§æ‡§∞‡§ø‡§ï‡§æ - Paricharika | AI Food Ordering</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 900px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            animation: slideUp 0.6s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            padding: 30px;
            text-align: center;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 70%);
            animation: pulse 3s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.3; }
            50% { transform: scale(1.1); opacity: 0.5; }
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 5px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
            position: relative;
            z-index: 1;
            font-weight: 600;
        }

        .header .subtitle {
            font-size: 1.1em;
            opacity: 0.95;
            position: relative;
            z-index: 1;
            font-weight: 400;
        }

        .menu-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 2px solid #e0e0e0;
            max-height: 200px;
            overflow-y: auto;
        }

        .menu-item-card {
            background: white;
            border-radius: 15px;
            padding: 12px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s;
        }

        .menu-item-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .menu-item-card:active {
            transform: translateY(-2px);
        }

        .menu-item-thumbnail {
            width: 70px;
            height: 70px;
            margin: 0 auto 8px;
            font-size: 3em;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
        }

        .menu-item-card h4 {
            font-size: 0.9em;
            margin-bottom: 3px;
            color: #333;
            font-weight: 600;
        }

        .menu-item-card .hindi-name {
            font-size: 0.75em;
            color: #666;
            margin-bottom: 5px;
        }

        .menu-item-card .price {
            font-size: 1em;
            font-weight: 700;
            color: #d32f2f;
        }

        .chat-container {
            height: 350px;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
            scroll-behavior: smooth;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
            animation: messageSlide 0.3s ease;
        }

        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message.user .bubble {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .message.assistant .bubble {
            background: white;
            color: #333;
            border: 2px solid #e0e0e0;
        }

        .bubble {
            max-width: 70%;
            padding: 12px 18px;
            border-radius: 18px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            word-wrap: break-word;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            flex-shrink: 0;
        }

        .message.user .avatar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .message.assistant .avatar {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .order-summary {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            padding: 20px;
            border-top: 3px solid #f5576c;
        }

        .order-summary h3 {
            color: #d32f2f;
            margin-bottom: 15px;
            font-size: 1.3em;
            font-weight: 600;
        }

        .order-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background: white;
            margin-bottom: 8px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .order-total {
            display: flex;
            justify-content: space-between;
            padding: 15px;
            background: #d32f2f;
            color: white;
            border-radius: 10px;
            font-size: 1.2em;
            font-weight: 700;
            margin-top: 10px;
        }

        .controls {
            padding: 20px;
            background: white;
            border-top: 1px solid #e0e0e0;
        }

        .input-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        #userInput {
            flex: 1;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            transition: all 0.3s;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', sans-serif;
        }

        #userInput:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.2);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-voice {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-voice.recording {
            animation: recordPulse 1s infinite;
        }

        @keyframes recordPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .button-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .status {
            text-align: center;
            padding: 10px;
            font-size: 14px;
            color: #666;
            font-style: italic;
        }

        .thinking {
            display: flex;
            gap: 5px;
            justify-content: center;
            padding: 10px;
        }

        .thinking span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #667eea;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .thinking span:nth-child(1) { animation-delay: -0.32s; }
        .thinking span:nth-child(2) { animation-delay: -0.16s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        .empty-order {
            text-align: center;
            color: #999;
            padding: 20px;
            font-style: italic;
        }

        .waveform-container {
            display: none;
            justify-content: center;
            align-items: center;
            gap: 3px;
            height: 60px;
            margin: 10px 0;
            padding: 10px;
            background: linear-gradient(135deg, rgba(240, 147, 251, 0.1) 0%, rgba(245, 87, 108, 0.1) 100%);
            border-radius: 15px;
        }

        .waveform-container.active {
            display: flex;
        }

        .waveform-bar {
            width: 4px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border-radius: 2px;
            animation: waveAnimation 1.2s ease-in-out infinite;
        }

        .waveform-bar:nth-child(1) { animation-delay: 0s; }
        .waveform-bar:nth-child(2) { animation-delay: 0.1s; }
        .waveform-bar:nth-child(3) { animation-delay: 0.2s; }
        .waveform-bar:nth-child(4) { animation-delay: 0.3s; }
        .waveform-bar:nth-child(5) { animation-delay: 0.4s; }
        .waveform-bar:nth-child(6) { animation-delay: 0.3s; }
        .waveform-bar:nth-child(7) { animation-delay: 0.2s; }
        .waveform-bar:nth-child(8) { animation-delay: 0.1s; }

        @keyframes waveAnimation {
            0%, 100% { height: 10px; }
            50% { height: 40px; }
        }

        @media (max-width: 600px) {
            .header h1 {
                font-size: 1.8em;
            }
            
            .bubble {
                max-width: 85%;
            }
            
            .btn {
                padding: 12px 20px;
                font-size: 14px;
            }

            .menu-gallery {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üçΩÔ∏è ‡§™‡§∞‡§ø‡§ö‡§æ‡§∞‡§ø‡§ï‡§æ</h1>
            <div class="subtitle">Paricharika - Your AI Food Ordering Assistant</div>
        </div>

        <!-- Food Gallery -->
        <div class="menu-gallery" id="menuGallery">
            <div class="menu-item-card" onclick="quickOrder('Chai', 20)">
                <div class="menu-item-thumbnail">‚òï</div>
                <h4>Chai</h4>
                <div class="hindi-name">‡§ö‡§æ‡§Ø</div>
                <div class="price">‚Çπ20</div>
            </div>
            <div class="menu-item-card" onclick="quickOrder('Coffee', 30)">
                <div class="menu-item-thumbnail">‚òï</div>
                <h4>Coffee</h4>
                <div class="hindi-name">‡§ï‡•â‡§´‡§º‡•Ä</div>
                <div class="price">‚Çπ30</div>
            </div>
            <div class="menu-item-card" onclick="quickOrder('Lassi', 40)">
                <div class="menu-item-thumbnail">ü•õ</div>
                <h4>Lassi</h4>
                <div class="hindi-name">‡§≤‡§∏‡•ç‡§∏‡•Ä</div>
                <div class="price">‚Çπ40</div>
            </div>
            <div class="menu-item-card" onclick="quickOrder('Samosa', 15)">
                <div class="menu-item-thumbnail">ü•ü</div>
                <h4>Samosa</h4>
                <div class="hindi-name">‡§∏‡§Æ‡•ã‡§∏‡§æ</div>
                <div class="price">‚Çπ15</div>
            </div>
            <div class="menu-item-card" onclick="quickOrder('Vada Pav', 25)">
                <div class="menu-item-thumbnail">üçî</div>
                <h4>Vada Pav</h4>
                <div class="hindi-name">‡§µ‡§°‡§º‡§æ ‡§™‡§æ‡§µ</div>
                <div class="price">‚Çπ25</div>
            </div>
            <div class="menu-item-card" onclick="quickOrder('Sandwich', 40)">
                <div class="menu-item-thumbnail">ü•™</div>
                <h4>Sandwich</h4>
                <div class="hindi-name">‡§∏‡•à‡§Ç‡§°‡§µ‡§ø‡§ö</div>
                <div class="price">‚Çπ40</div>
            </div>
            <div class="menu-item-card" onclick="quickOrder('Dal Chawal', 80)">
                <div class="menu-item-thumbnail">üçõ</div>
                <h4>Dal Chawal</h4>
                <div class="hindi-name">‡§¶‡§æ‡§≤ ‡§ö‡§æ‡§µ‡§≤</div>
                <div class="price">‚Çπ80</div>
            </div>
            <div class="menu-item-card" onclick="quickOrder('Thali', 120)">
                <div class="menu-item-thumbnail">üç±</div>
                <h4>Thali</h4>
                <div class="hindi-name">‡§•‡§æ‡§≤‡•Ä</div>
                <div class="price">‚Çπ120</div>
            </div>
        </div>

        <div class="chat-container" id="chatContainer">
            <div class="message assistant">
                <div class="avatar">ü§ñ</div>
                <div class="bubble">
                    Namaste! üôè Main Paricharika hoon. Main aapki order lene mein madad karungi. Kya lena pasand karenge?
                </div>
            </div>
        </div>

        <div class="order-summary" id="orderSummary">
            <h3>üìã Current Order</h3>
            <div class="empty-order">No items yet. Start ordering!</div>
        </div>

        <div class="controls">
            <div class="input-container">
                <input 
                    type="text" 
                    id="userInput" 
                    placeholder="Type your order here... (e.g., ek chai do samosa)"
                    onkeypress="if(event.key==='Enter') sendMessage()"
                >
                <button class="btn btn-primary" onclick="sendMessage()">Send</button>
            </div>

            <!-- Waveform Animation -->
            <div class="waveform-container" id="waveform">
                <div class="waveform-bar"></div>
                <div class="waveform-bar"></div>
                <div class="waveform-bar"></div>
                <div class="waveform-bar"></div>
                <div class="waveform-bar"></div>
                <div class="waveform-bar"></div>
                <div class="waveform-bar"></div>
                <div class="waveform-bar"></div>
            </div>
            
            <div class="button-row">
                <button class="btn btn-voice" id="voiceBtn" onclick="toggleVoice()">
                    <span id="voiceIcon">üé§</span>
                    <span id="voiceText">Voice Order</span>
                </button>
                <button class="btn btn-primary" onclick="showMenu()">üìã Full Menu</button>
                <button class="btn btn-primary" onclick="confirmOrder()">‚úÖ Confirm Order</button>
            </div>
            
            <div class="status" id="status"></div>
        </div>
    </div>

    <script>
        const API_KEYS = {
            GROQ: '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'
        };

        const MENU = {
            beverages: [
                { name: 'Chai', hindi: '‡§ö‡§æ‡§Ø', price: 20, emoji: '‚òï' },
                { name: 'Coffee', hindi: '‡§ï‡•â‡§´‡§º‡•Ä', price: 30, emoji: '‚òï' },
                { name: 'Lassi', hindi: '‡§≤‡§∏‡•ç‡§∏‡•Ä', price: 40, emoji: 'ü•õ' }
            ],
            snacks: [
                { name: 'Samosa', hindi: '‡§∏‡§Æ‡•ã‡§∏‡§æ', price: 15, emoji: 'ü•ü' },
                { name: 'Vada Pav', hindi: '‡§µ‡§°‡§º‡§æ ‡§™‡§æ‡§µ', price: 25, emoji: 'üçî' },
                { name: 'Sandwich', hindi: '‡§∏‡•à‡§Ç‡§°‡§µ‡§ø‡§ö', price: 40, emoji: 'ü•™' }
            ],
            meals: [
                { name: 'Dal Chawal', hindi: '‡§¶‡§æ‡§≤ ‡§ö‡§æ‡§µ‡§≤', price: 80, emoji: 'üçõ' },
                { name: 'Thali', hindi: '‡§•‡§æ‡§≤‡•Ä', price: 120, emoji: 'üç±' }
            ]
        };

        let currentOrder = [];
        let conversationHistory = [];
        let isRecording = false;
        let mediaRecorder = null;
        let audioChunks = [];
        let silenceTimer = null;
        let audioContext = null;
        let analyser = null;
        let audioStream = null;
        let speechSynthesis = window.speechSynthesis;
        let hindiVoice = null;

        // Initialize Hindi voice for TTS
        function initVoices() {
            const voices = speechSynthesis.getVoices();
            hindiVoice = voices.find(voice => 
                voice.lang.startsWith('hi') || 
                voice.lang.includes('IN')
            ) || voices.find(voice => voice.lang.startsWith('en-IN')) || voices[0];
        }

        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = initVoices;
        }

        function quickOrder(itemName, price) {
            currentOrder.push({ name: itemName, price: price, quantity: 1 });
            updateOrderSummary();
            addMessage(`${itemName} added to order! ‚úÖ`, false);
            speakText(`${itemName} order mein add ho gaya`);
        }

        function addMessage(text, isUser = false) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'assistant'}`;
            
            messageDiv.innerHTML = `
                <div class="avatar">${isUser ? 'üë§' : 'ü§ñ'}</div>
                <div class="bubble">${text}</div>
            `;
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function showThinking() {
            const chatContainer = document.getElementById('chatContainer');
            const thinkingDiv = document.createElement('div');
            thinkingDiv.id = 'thinking';
            thinkingDiv.className = 'thinking';
            thinkingDiv.innerHTML = '<span></span><span></span><span></span>';
            chatContainer.appendChild(thinkingDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function removeThinking() {
            const thinking = document.getElementById('thinking');
            if (thinking) thinking.remove();
        }

        function setStatus(text) {
            document.getElementById('status').textContent = text;
        }

        async function sendMessage() {
            const input = document.getElementById('userInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            input.value = '';
            addMessage(message, true);
            
            extractOrderFromText(message);
            
            showThinking();
            try {
                const response = await getAIResponse(message);
                removeThinking();
                addMessage(response);
                speakText(response);
            } catch (error) {
                removeThinking();
                addMessage('Sorry, kuch problem ho gayi. Please try again.');
                console.error(error);
            }
            
            updateOrderSummary();
        }

        async function getAIResponse(userMessage) {
            conversationHistory.push({ role: 'user', content: userMessage });
            
            const systemPrompt = `You are Paricharika, a friendly food ordering assistant. Speak in natural Hinglish.
Menu: Chai(‚Çπ20), Coffee(‚Çπ30), Lassi(‚Çπ40), Samosa(‚Çπ15), Vada Pav(‚Çπ25), Sandwich(‚Çπ40), Dal Chawal(‚Çπ80), Thali(‚Çπ120)
Respond in 1-2 sentences only in conversational Hinglish.`;

            const messages = [
                { role: 'system', content: systemPrompt },
                ...conversationHistory.slice(-4)
            ];

            try {
                const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${API_KEYS.GROQ}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'llama-3.3-70b-versatile',
                        messages: messages,
                        temperature: 0.7,
                        max_tokens: 150
                    })
                });

                if (!response.ok) {
                    throw new Error('API request failed');
                }

                const data = await response.json();
                const aiResponse = data.choices[0].message.content;
                
                conversationHistory.push({ role: 'assistant', content: aiResponse });
                return aiResponse;
                
            } catch (error) {
                console.error('AI Error:', error);
                return getRuleBasedResponse(userMessage);
            }
        }

        function getRuleBasedResponse(text) {
            const lower = text.toLowerCase();
            
            if (lower.includes('menu') || lower.includes('kya hai')) {
                return 'Hamare paas chai, coffee, lassi, samosa, vada pav, sandwich, dal chawal, thali available hai. Kya lenge?';
            } else if (lower.includes('chai')) {
                return 'Bilkul! Chai aa rahi hai, ‚Çπ20 ki. Aur kuch?';
            } else if (lower.includes('samosa')) {
                return 'Zaroor! Samosa aa raha hai, ‚Çπ15 ka. Kuch aur?';
            }
            return 'Ji boliye, aap kya order karna chahenge?';
        }

        function extractOrderFromText(text) {
            const lower = text.toLowerCase();
            const items = {
                'chai': { name: 'Chai', price: 20 },
                'coffee': { name: 'Coffee', price: 30 },
                'lassi': { name: 'Lassi', price: 40 },
                'samosa': { name: 'Samosa', price: 15 },
                'vada pav': { name: 'Vada Pav', price: 25 },
                'sandwich': { name: 'Sandwich', price: 40 },
                'dal chawal': { name: 'Dal Chawal', price: 80 },
                'thali': { name: 'Thali', price: 120 }
            };

            const qtyMap = { 'ek': 1, 'do': 2, 'teen': 3, 'char': 4, '1': 1, '2': 2, '3': 3, '4': 4 };

            for (const [key, item] of Object.entries(items)) {
                if (lower.includes(key)) {
                    let qty = 1;
                    for (const [word, num] of Object.entries(qtyMap)) {
                        if (lower.includes(word)) {
                            qty = num;
                            break;
                        }
                    }
                    currentOrder.push({ ...item, quantity: qty });
                }
            }
        }

        function updateOrderSummary() {
            const summaryDiv = document.getElementById('orderSummary');
            
            if (currentOrder.length === 0) {
                summaryDiv.innerHTML = `
                    <h3>üìã Current Order</h3>
                    <div class="empty-order">No items yet. Start ordering!</div>
                `;
                return;
            }

            let html = '<h3>üìã Current Order</h3>';
            let total = 0;

            currentOrder.forEach((item, idx) => {
                const itemTotal = item.price * item.quantity;
                total += itemTotal;
                html += `
                    <div class="order-item">
                        <span>${item.name} x${item.quantity}</span>
                        <span>‚Çπ${itemTotal}</span>
                    </div>
                `;
            });

            html += `
                <div class="order-total">
                    <span>Total</span>
                    <span>‚Çπ${total}</span>
                </div>
            `;

            summaryDiv.innerHTML = html;
        }

        function showMenu() {
            let menuText = 'üìã *Complete Menu*\n\n';
            
            for (const [category, items] of Object.entries(MENU)) {
                menuText += `*${category.toUpperCase()}*\n`;
                items.forEach(item => {
                    menuText += `${item.emoji} ${item.name} (${item.hindi}) - ‚Çπ${item.price}\n`;
                });
                menuText += '\n';
            }
            
            addMessage(menuText.replace(/\n/g, '<br>').replace(/\*/g, '<strong>').replace(/<\/strong>/g, '</strong>'));
        }

        function resetSilenceTimer() {
            if (silenceTimer) {
                clearTimeout(silenceTimer);
            }
            
            silenceTimer = setTimeout(() => {
                if (isRecording) {
                    console.log('Dude, are you speaking???üëÄ');
                    toggleVoice();
                }
            }, 2500);
        }

        function detectSound() {
            if (!analyser || !isRecording) return;

            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(dataArray);

            const average = dataArray.reduce((a, b) => a + b) / dataArray.length;
            
            if (average > 10) {
                resetSilenceTimer();
            }

            if (isRecording) {
                requestAnimationFrame(detectSound);
            }
        }
        function detectSpeechStart() {
    const dataArray = new Uint8Array(analyser.frequencyBinCount);

    function check() {
        analyser.getByteFrequencyData(dataArray);

        const avg = dataArray.reduce((a, b) => a + b) / dataArray.length;

        if (avg > 18 && !isRecording) { 
            console.log("Voice detected. Starting recording...");
            toggleVoice(); // start recording
            return;
        }

        requestAnimationFrame(check);
    }

    check();
}

        async function toggleVoice() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                alert('Voice recording not supported in your browser');
                return;
            }

            const voiceBtn = document.getElementById('voiceBtn');
            const voiceIcon = document.getElementById('voiceIcon');
            const voiceText = document.getElementById('voiceText');
            const waveform = document.getElementById('waveform');

            if (!isRecording) {
                try {
                    audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });

                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    analyser = audioContext.createAnalyser();
                    const source = audioContext.createMediaStreamSource(audioStream);
                    source.connect(analyser);
                    analyser.fftSize = 256;

                    let options = { mimeType: "audio/webm" };
                    if (!MediaRecorder.isTypeSupported("audio/webm")) {
                        options = { mimeType: "audio/ogg" };
                    }
                    if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                        options = {};
                    }

                    mediaRecorder = new MediaRecorder(audioStream, options);
                    audioChunks = [];

                    mediaRecorder.ondataavailable = (e) => {
                        audioChunks.push(e.data);
                    };

                    mediaRecorder.onstop = async () => {
                        const audioBlob = new Blob(audioChunks, { type: options.mimeType });
                        await processVoiceInput(audioBlob);
                        
                        // audioStream.getTracks().forEach(track => track.stop());
                        // if (audioContext) {
                        //     audioContext.close();
                        }
                    };

                    mediaRecorder.start();
                    isRecording = true;

                    voiceBtn.classList.add('recording');
                    voiceIcon.textContent = '‚èπÔ∏è';
                    voiceText.textContent = 'Listening...';
                    waveform.classList.add('active');
                    setStatus('üé§ Listening... Speak now! (Auto-stops after 5s silence)');

                    resetSilenceTimer();
                    detectSound();

                } catch (error) {
                    console.error(error);
                    alert('Microphone access denied');
                }
            } else {
                if (silenceTimer) {
                    clearTimeout(silenceTimer);
                }

                mediaRecorder.stop();
                isRecording = false;

                voiceBtn.classList.remove('recording');
                voiceIcon.textContent = 'üé§';
                voiceText.textContent = 'Voice Order';
                waveform.classList.remove('active');
                setStatus('Processing...');
            }
        }
        async function startPassiveListening() {

    try {
        audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioContext.createAnalyser();
        
        const source = audioContext.createMediaStreamSource(audioStream);
        source.connect(analyser);
        analyser.fftSize = 256;

        detectSpeechStart();
    } catch (error) {
        console.error("Microphone access failed:", error);
    }
}

        async function processVoiceInput(audioBlob) {
            const formData = new FormData();
            formData.append("audio", audioBlob, "audio.webm");

            try {
                const response = await fetch("https://paricharika.onrender.com/asr", {
                    method: "POST",
                    body: formData
                });

                const data = await response.json();
                console.log("Transcript from backend:", data);

                if (data.transcript) {
                    document.getElementById("userInput").value = data.transcript;
                    setStatus("üé§ Processing your order...");
                    sendMessage();
                    // After sending the message, start listening again automatically
                    setTimeout(() => {
                        startPassiveListening();
                    }, 500);


                } else {
                    setStatus("‚ùå Could not understand. Please try again.");
                }
            } catch (error) {
                console.error(error);
                setStatus("‚ùå Error processing audio. Please try typing instead.");
            }
        }
        

        function speakText(text) {
            if (!speechSynthesis) return;
            
            speechSynthesis.cancel();
            
            const utterance = new SpeechSynthesisUtterance(text);
            
            if (hindiVoice) {
                utterance.voice = hindiVoice;
            }
            
            utterance.lang = 'hi-IN';
            utterance.rate = 0.9;
            utterance.pitch = 1.0;
            utterance.volume = 1.0;
            
            speechSynthesis.speak(utterance);
        }

        function confirmOrder() {
            if (currentOrder.length === 0) {
                alert('Koi order nahi hai! Pehle order karein.');
                return;
            }

            const total = currentOrder.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const orderId = 'ORD' + Date.now();
            
            const confirmMsg = `‚úÖ Order Confirmed!\nOrder ID: ${orderId}\nTotal: ‚Çπ${total}\n\nDhanyavaad! Aapka order 10-15 minute mein ready hoga. üôè`;
            addMessage(confirmMsg);
            speakText('Order confirm ho gaya. Dhanyavaad!');
            
            currentOrder = [];
            updateOrderSummary();
            setStatus('');
        }

        window.onload = () => {
            initVoices();
            if (API_KEYS.GROQ === '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') {
                setStatus('‚ö†Ô∏è Please update API keys in the script!');
            }
        };
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡§™‡§∞‡§ø‡§ö‡§æ‡§∞‡§ø‡§ï‡§æ - Paricharika | AI Food Ordering</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 900px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            animation: slideUp 0.6s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            padding: 30px;
            text-align: center;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 70%);
            animation: pulse 3s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.3; }
            50% { transform: scale(1.1); opacity: 0.5; }
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 5px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
            position: relative;
            z-index: 1;
            font-weight: 600;
        }

        .header .subtitle {
            font-size: 1.1em;
            opacity: 0.95;
            position: relative;
            z-index: 1;
            font-weight: 400;
        }

        .menu-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            padding: 20px;
            background: #f8f9fa;
            border-bottom: 2px solid #e0e0e0;
            max-height: 200px;
            overflow-y: auto;
        }

        .menu-item-card {
            background: white;
            border-radius: 15px;
            padding: 12px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s;
        }

        .menu-item-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .menu-item-card:active {
            transform: translateY(-2px);
        }

        .menu-item-thumbnail {
            width: 70px;
            height: 70px;
            margin: 0 auto 8px;
            font-size: 3em;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
        }

        .menu-item-card h4 {
            font-size: 0.9em;
            margin-bottom: 3px;
            color: #333;
            font-weight: 600;
        }

        .menu-item-card .hindi-name {
            font-size: 0.75em;
            color: #666;
            margin-bottom: 5px;
        }

        .menu-item-card .price {
            font-size: 1em;
            font-weight: 700;
            color: #d32f2f;
        }

        .chat-container {
            height: 350px;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
            scroll-behavior: smooth;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
            animation: messageSlide 0.3s ease;
        }

        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message.user .bubble {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .message.assistant .bubble {
            background: white;
            color: #333;
            border: 2px solid #e0e0e0;
        }

        .bubble {
            max-width: 70%;
            padding: 12px 18px;
            border-radius: 18px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            word-wrap: break-word;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            flex-shrink: 0;
        }

        .message.user .avatar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .message.assistant .avatar {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .order-summary {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            padding: 20px;
            border-top: 3px solid #f5576c;
        }

        .order-summary h3 {
            color: #d32f2f;
            margin-bottom: 15px;
            font-size: 1.3em;
            font-weight: 600;
        }

        .order-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background: white;
            margin-bottom: 8px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .order-total {
            display: flex;
            justify-content: space-between;
            padding: 15px;
            background: #d32f2f;
            color: white;
            border-radius: 10px;
            font-size: 1.2em;
            font-weight: 700;
            margin-top: 10px;
        }

        .controls {
            padding: 20px;
            background: white;
            border-top: 1px solid #e0e0e0;
        }

        .input-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        #userInput {
            flex: 1;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            transition: all 0.3s;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', sans-serif;
        }

        #userInput:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.2);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-voice {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-voice.listening {
            animation: recordPulse 1s infinite;
        }

        @keyframes recordPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .button-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .status {
            text-align: center;
            padding: 10px;
            font-size: 14px;
            color: #666;
            font-style: italic;
        }

        .thinking {
            display: flex;
            gap: 5px;
            justify-content: center;
            padding: 10px;
        }

        .thinking span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #667eea;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .thinking span:nth-child(1) { animation-delay: -0.32s; }
        .thinking span:nth-child(2) { animation-delay: -0.16s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        .empty-order {
            text-align: center;
            color: #999;
            padding: 20px;
            font-style: italic;
        }

        .waveform-container {
            display: none;
            justify-content: center;
            align-items: center;
            gap: 3px;
            height: 60px;
            margin: 10px 0;
            padding: 10px;
            background: linear-gradient(135deg, rgba(240, 147, 251, 0.1) 0%, rgba(245, 87, 108, 0.1) 100%);
            border-radius: 15px;
        }

        .waveform-container.active {
            display: flex;
        }

        .waveform-bar {
            width: 4px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border-radius: 2px;
            animation: waveAnimation 1.2s ease-in-out infinite;
        }

        .waveform-bar:nth-child(1) { animation-delay: 0s; }
        .waveform-bar:nth-child(2) { animation-delay: 0.1s; }
        .waveform-bar:nth-child(3) { animation-delay: 0.2s; }
        .waveform-bar:nth-child(4) { animation-delay: 0.3s; }
        .waveform-bar:nth-child(5) { animation-delay: 0.4s; }
        .waveform-bar:nth-child(6) { animation-delay: 0.3s; }
        .waveform-bar:nth-child(7) { animation-delay: 0.2s; }
        .waveform-bar:nth-child(8) { animation-delay: 0.1s; }

        @keyframes waveAnimation {
            0%, 100% { height: 10px; }
            50% { height: 40px; }
        }

        @media (max-width: 600px) {
            .header h1 {
                font-size: 1.8em;
            }
            
            .bubble {
                max-width: 85%;
            }
            
            .btn {
                padding: 12px 20px;
                font-size: 14px;
            }

            .menu-gallery {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üçΩÔ∏è ‡§™‡§∞‡§ø‡§ö‡§æ‡§∞‡§ø‡§ï‡§æ</h1>
            <div class="subtitle">Paricharika - Your AI Food Ordering Assistant</div>
        </div>

        <div class="menu-gallery" id="menuGallery">
            <div class="menu-item-card" onclick="quickOrder('Chai', 20)">
                <div class="menu-item-thumbnail">‚òï</div>
                <h4>Chai</h4>
                <div class="hindi-name">‡§ö‡§æ‡§Ø</div>
                <div class="price">‚Çπ20</div>
            </div>
            <div class="menu-item-card" onclick="quickOrder('Coffee', 30)">
                <div class="menu-item-thumbnail">‚òï</div>
                <h4>Coffee</h4>
                <div class="hindi-name">‡§ï‡•â‡§´‡§º‡•Ä</div>
                <div class="price">‚Çπ30</div>
            </div>
            <div class="menu-item-card" onclick="quickOrder('Lassi', 40)">
                <div class="menu-item-thumbnail">ü•õ</div>
                <h4>Lassi</h4>
                <div class="hindi-name">‡§≤‡§∏‡•ç‡§∏‡•Ä</div>
                <div class="price">‚Çπ40</div>
            </div>
            <div class="menu-item-card" onclick="quickOrder('Samosa', 15)">
                <div class="menu-item-thumbnail">ü•ü</div>
                <h4>Samosa</h4>
                <div class="hindi-name">‡§∏‡§Æ‡•ã‡§∏‡§æ</div>
                <div class="price">‚Çπ15</div>
            </div>
            <div class="menu-item-card" onclick="quickOrder('Vada Pav', 25)">
                <div class="menu-item-thumbnail">üçî</div>
                <h4>Vada Pav</h4>
                <div class="hindi-name">‡§µ‡§°‡§º‡§æ ‡§™‡§æ‡§µ</div>
                <div class="price">‚Çπ25</div>
            </div>
            <div class="menu-item-card" onclick="quickOrder('Sandwich', 40)">
                <div class="menu-item-thumbnail">ü•™</div>
                <h4>Sandwich</h4>
                <div class="hindi-name">‡§∏‡•à‡§Ç‡§°‡§µ‡§ø‡§ö</div>
                <div class="price">‚Çπ40</div>
            </div>
            <div class="menu-item-card" onclick="quickOrder('Dal Chawal', 80)">
                <div class="menu-item-thumbnail">üçõ</div>
                <h4>Dal Chawal</h4>
                <div class="hindi-name">‡§¶‡§æ‡§≤ ‡§ö‡§æ‡§µ‡§≤</div>
                <div class="price">‚Çπ80</div>
            </div>
            <div class="menu-item-card" onclick="quickOrder('Thali', 120)">
                <div class="menu-item-thumbnail">üç±</div>
                <h4>Thali</h4>
                <div class="hindi-name">‡§•‡§æ‡§≤‡•Ä</div>
                <div class="price">‚Çπ120</div>
            </div>
        </div>

        <div class="chat-container" id="chatContainer">
            <div class="message assistant">
                <div class="avatar">ü§ñ</div>
                <div class="bubble">
                    Namaste! üôè Main Paricharika hoon. Main aapki order lene mein madad karungi. Kya lena pasand karenge?
                </div>
            </div>
        </div>

        <div class="order-summary" id="orderSummary">
            <h3>üìã Current Order</h3>
            <div class="empty-order">No items yet. Start ordering!</div>
        </div>

        <div class="controls">
            <div class="input-container">
                <input 
                    type="text" 
                    id="userInput" 
                    placeholder="Type your order here... (e.g., ek chai do samosa)"
                    onkeypress="if(event.key==='Enter') sendMessage()"
                >
                <button class="btn btn-primary" onclick="sendMessage()">Send</button>
            </div>

            <div class="waveform-container" id="waveform">
                <div class="waveform-bar"></div>
                <div class="waveform-bar"></div>
                <div class="waveform-bar"></div>
                <div class="waveform-bar"></div>
                <div class="waveform-bar"></div>
                <div class="waveform-bar"></div>
                <div class="waveform-bar"></div>
                <div class="waveform-bar"></div>
            </div>
            
            <div class="button-row">
                <button class="btn btn-voice" id="voiceBtn" onclick="toggleVoiceMode()">
                    <span id="voiceIcon">üé§</span>
                    <span id="voiceText">Start Voice Mode</span>
                </button>
                <button class="btn btn-primary" onclick="showMenu()">üìã Full Menu</button>
                <button class="btn btn-primary" onclick="confirmOrder()">‚úÖ Confirm Order</button>
            </div>
            
            <div class="status" id="status"></div>
        </div>
    </div>

    <script>
        const API_KEYS = {
            GEMINI: 'AIzaSyCDaF9tmMwtfTENhJCCaIyIeRgelNnLE4w'  // Replace with your Google AI Studio API key
        };

        const MENU = {
            'chai': { name: 'Chai', hindi: '‡§ö‡§æ‡§Ø', price: 20, emoji: '‚òï' },
            'coffee': { name: 'Coffee', hindi: '‡§ï‡•â‡§´‡§º‡•Ä', price: 30, emoji: '‚òï' },
            'lassi': { name: 'Lassi', hindi: '‡§≤‡§∏‡•ç‡§∏‡•Ä', price: 40, emoji: 'ü•õ' },
            'samosa': { name: 'Samosa', hindi: '‡§∏‡§Æ‡•ã‡§∏‡§æ', price: 15, emoji: 'ü•ü' },
            'vada pav': { name: 'Vada Pav', hindi: '‡§µ‡§°‡§º‡§æ ‡§™‡§æ‡§µ', price: 25, emoji: 'üçî' },
            'sandwich': { name: 'Sandwich', hindi: '‡§∏‡•à‡§Ç‡§°‡§µ‡§ø‡§ö', price: 40, emoji: 'ü•™' },
            'dal chawal': { name: 'Dal Chawal', hindi: '‡§¶‡§æ‡§≤ ‡§ö‡§æ‡§µ‡§≤', price: 80, emoji: 'üçõ' },
            'thali': { name: 'Thali', hindi: '‡§•‡§æ‡§≤‡•Ä', price: 120, emoji: 'üç±' }
        };

        let currentOrder = [];
        let conversationHistory = [];
        let voiceModeActive = false;
        let isListening = false;
        let isSpeaking = false;
        let mediaRecorder = null;
        let audioChunks = [];
        let audioContext = null;
        let analyser = null;
        let audioStream = null;
        let voiceDetectionInterval = null;
        let currentUtterance = null;

        const VOICE_THRESHOLD = 25;
        const SILENCE_DURATION = 2000;
        let silenceTimer = null;
        let lastSpeechTime = Date.now();

        function quickOrder(itemName, price) {
            currentOrder.push({ name: itemName, price: price, quantity: 1 });
            updateOrderSummary();
            addMessage(`${itemName} added to order! ‚úÖ`, false);
            speakText(`${itemName} order mein add ho gaya`);
        }

        function addMessage(text, isUser = false) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user' : 'assistant'}`;
            
            messageDiv.innerHTML = `
                <div class="avatar">${isUser ? 'üë§' : 'ü§ñ'}</div>
                <div class="bubble">${text}</div>
            `;
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function showThinking() {
            const chatContainer = document.getElementById('chatContainer');
            const thinkingDiv = document.createElement('div');
            thinkingDiv.id = 'thinking';
            thinkingDiv.className = 'thinking';
            thinkingDiv.innerHTML = '<span></span><span></span><span></span>';
            chatContainer.appendChild(thinkingDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function removeThinking() {
            const thinking = document.getElementById('thinking');
            if (thinking) thinking.remove();
        }

        function setStatus(text) {
            document.getElementById('status').textContent = text;
        }

        async function sendMessage() {
            const input = document.getElementById('userInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            input.value = '';
            addMessage(message, true);
            
            showThinking();
            try {
                const response = await getAIResponse(message);
                removeThinking();
                addMessage(response);
                
                if (voiceModeActive) {
                    await speakText(response);
                }
            } catch (error) {
                removeThinking();
                addMessage('Sorry, kuch problem ho gayi. Please try again.');
                console.error(error);
            }
        }

        async function getAIResponse(userMessage) {
            conversationHistory.push({ role: 'user', content: userMessage });
            
            const currentOrderStr = currentOrder.length > 0 
                ? `Current Order: ${currentOrder.map(i => `${i.name} x${i.quantity}`).join(', ')}`
                : 'Current Order: Empty';

            const systemPrompt = `You are Paricharika, a friendly food ordering assistant. Speak in natural Hinglish (Hindi+English mix).

Menu Items:
- Chai (‚Çπ20), Coffee (‚Çπ30), Lassi (‚Çπ40)
- Samosa (‚Çπ15), Vada Pav (‚Çπ25), Sandwich (‚Çπ40)
- Dal Chawal (‚Çπ80), Thali (‚Çπ120)

${currentOrderStr}

Instructions:
- Understand user intent: ADD, REMOVE, MODIFY, or QUERY
- For order changes, return JSON: {"action": "add/remove/clear", "item": "chai", "quantity": 2}
- For "remove all"/"cancel order": {"action": "clear"}
- For queries (menu, price, etc.), respond conversationally in Hinglish
- Keep responses brief (1-2 sentences)
- Be friendly and natural

Examples:
User: "ek chai aur do samosa"
Response: {"action": "add", "item": "chai", "quantity": 1}{"action": "add", "item": "samosa", "quantity": 2}

User: "samosa nahi chahiye"
Response: {"action": "remove", "item": "samosa"}

User: "thali ka price kya hai?"
Response: Thali ka price ‚Çπ120 hai. Order karein?`;

            const conversationText = conversationHistory.slice(-6).map(msg => 
                `${msg.role === 'user' ? 'Customer' : 'Paricharika'}: ${msg.content}`
            ).join('\n');

            const fullPrompt = `${systemPrompt}\n\nConversation:\n${conversationText}\n\nRespond now:`;

            try {
                // Using Gemini API
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEYS.GEMINI}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: fullPrompt
                            }]
                        }],
                        generationConfig: {
                            temperature: 0.7,
                            maxOutputTokens: 200,
                            topP: 0.8,
                            topK: 40
                        }
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Gemini API Error:', errorData);
                    throw new Error('API request failed');
                }

                const data = await response.json();
                let aiResponse = data.candidates[0].content.parts[0].text.trim();
                
                // Try to parse JSON for order updates
                const jsonMatches = aiResponse.match(/\{[^}]*"action"[^}]*\}/g);
                if (jsonMatches && jsonMatches.length > 0) {
                    jsonMatches.forEach(jsonStr => {
                        try {
                            const orderUpdate = JSON.parse(jsonStr);
                            processOrderUpdate(orderUpdate);
                        } catch (e) {
                            console.error('JSON parse error:', e);
                        }
                    });
                    
                    // Generate confirmation message
                    const lastUpdate = JSON.parse(jsonMatches[jsonMatches.length - 1]);
                    if (lastUpdate.action === 'add') {
                        aiResponse = `${lastUpdate.item} ${lastUpdate.quantity > 1 ? lastUpdate.quantity + ' quantity' : ''} add kar diya! Kuch aur?`;
                    } else if (lastUpdate.action === 'remove') {
                        aiResponse = `${lastUpdate.item} remove kar diya. Aur kuch?`;
                    } else if (lastUpdate.action === 'clear') {
                        aiResponse = 'Pura order cancel kar diya. Naya order karein?';
                    }
                }
                
                conversationHistory.push({ role: 'assistant', content: aiResponse });
                return aiResponse;
                
            } catch (error) {
                console.error('AI Error:', error);
                return 'Kuch technical problem hai. Dobara try karein ya type karke order dein.';
            }
        }

        function processOrderUpdate(update) {
            const itemKey = update.item?.toLowerCase().trim();
            
            if (update.action === 'clear') {
                currentOrder = [];
            } else if (update.action === 'add' && MENU[itemKey]) {
                const existing = currentOrder.find(i => i.name.toLowerCase() === MENU[itemKey].name.toLowerCase());
                if (existing) {
                    existing.quantity += (update.quantity || 1);
                } else {
                    currentOrder.push({ 
                        name: MENU[itemKey].name, 
                        price: MENU[itemKey].price, 
                        quantity: update.quantity || 1 
                    });
                }
            } else if (update.action === 'remove') {
                const existing = currentOrder.find(i => 
                    i.name.toLowerCase().includes(itemKey) || 
                    itemKey.includes(i.name.toLowerCase())
                );
                if (existing) {
                    const removeQty = update.quantity || existing.quantity;
                    existing.quantity -= removeQty;
                    if (existing.quantity <= 0) {
                        currentOrder = currentOrder.filter(i => i !== existing);
                    }
                }
            }
            
            updateOrderSummary();
        }

        function updateOrderSummary() {
            const summaryDiv = document.getElementById('orderSummary');
            
            if (currentOrder.length === 0) {
                summaryDiv.innerHTML = `
                    <h3>üìã Current Order</h3>
                    <div class="empty-order">No items yet. Start ordering!</div>
                `;
                return;
            }

            let html = '<h3>üìã Current Order</h3>';
            let total = 0;

            currentOrder.forEach((item) => {
                const itemTotal = item.price * item.quantity;
                total += itemTotal;
                html += `
                    <div class="order-item">
                        <span>${item.name} x${item.quantity}</span>
                        <span>‚Çπ${itemTotal}</span>
                    </div>
                `;
            });

            html += `
                <div class="order-total">
                    <span>Total</span>
                    <span>‚Çπ${total}</span>
                </div>
            `;

            summaryDiv.innerHTML = html;
        }

        function showMenu() {
            let menuText = 'üìã Complete Menu:\n\n';
            menuText += 'Beverages: Chai(‚Çπ20), Coffee(‚Çπ30), Lassi(‚Çπ40)\n';
            menuText += 'Snacks: Samosa(‚Çπ15), Vada Pav(‚Çπ25), Sandwich(‚Çπ40)\n';
            menuText += 'Meals: Dal Chawal(‚Çπ80), Thali(‚Çπ120)';
            
            addMessage(menuText.replace(/\n/g, '<br>'));
        }

        async function speakText(text) {
            return new Promise(async (resolve) => {
                if (isSpeaking) {
                    stopSpeaking();
                }
                
                isSpeaking = true;
                setStatus('üîä Speaking...');
                
                try {
                    // Use ResponsiveVoice or browser TTS
                    if (window.responsiveVoice) {
                        responsiveVoice.speak(text, "Hindi Female", {
                            rate: 0.9,
                            pitch: 1,
                            onend: () => {
                                isSpeaking = false;
                                if (voiceModeActive) {
                                    startPassiveListening();
                                }
                                resolve();
                            }
                        });
                    } else {
                        // Fallback to Web Speech API
                        currentUtterance = new SpeechSynthesisUtterance(text);
                        currentUtterance.lang = 'hi-IN';
                        currentUtterance.rate = 0.9;
                        currentUtterance.pitch = 1;
                        
                        currentUtterance.onend = () => {
                            isSpeaking = false;
                            if (voiceModeActive) {
                                startPassiveListening();
                            }
                            resolve();
                        };
                        
                        speechSynthesis.speak(currentUtterance);
                    }
                } catch (error) {
                    console.error('TTS Error:', error);
                    isSpeaking = false;
                    resolve();
                }
            });
        }

        function stopSpeaking() {
            if (window.responsiveVoice) {
                responsiveVoice.cancel();
            } else {
                speechSynthesis.cancel();
            }
            isSpeaking = false;
        }

        async function toggleVoiceMode() {
            if (!voiceModeActive) {
                await startVoiceMode();
            } else {
                stopVoiceMode();
            }
        }

        async function startVoiceMode() {
            try {
                audioStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                });

                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                const source = audioContext.createMediaStreamSource(audioStream);
                source.connect(analyser);
                analyser.fftSize = 512;
                analyser.smoothingTimeConstant = 0.8;

                voiceModeActive = true;
                
                const voiceBtn = document.getElementById('voiceBtn');
                const voiceIcon = document.getElementById('voiceIcon');
                const voiceText = document.getElementById('voiceText');
                
                voiceBtn.style.background = 'linear-gradient(135deg, #f5576c 0%, #f093fb 100%)';
                voiceIcon.textContent = 'üî¥';
                voiceText.textContent = 'Voice Mode Active';
                
                setStatus('üé§ Voice mode active - waiting for speech...');
                
                startPassiveListening();
                
            } catch (error) {
                console.error('Microphone Error:', error);
                alert('Microphone access denied or not available');
            }
        }

        function stopVoiceMode() {
            voiceModeActive = false;
            isListening = false;
            
            stopSpeaking();
            
            if (voiceDetectionInterval) {
                clearInterval(voiceDetectionInterval);
            }
            
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
            
            if (audioStream) {
                audioStream.getTracks().forEach(track => track.stop());
            }
            
            if (audioContext) {
                audioContext.close();
            }
            
            const voiceBtn = document.getElementById('voiceBtn');
            const voiceIcon = document.getElementById('voiceIcon');
            const voiceText = document.getElementById('voiceText');
            const waveform = document.getElementById('waveform');
            
            voiceBtn.style.background = 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)';
            voiceIcon.textContent = 'üé§';
            voiceText.textContent = 'Start Voice Mode';
            waveform.classList.remove('active');
            
            setStatus('');
        }

        function startPassiveListening() {
            if (!voiceModeActive || isListening || isSpeaking) return;
            
            setStatus('üéß Listening for voice...');
            
            voiceDetectionInterval = setInterval(() => {
                if (isSpeaking || !voiceModeActive) return;
                
                const dataArray = new Uint8Array(analyser.frequencyBinCount);
                analyser.getByteFrequencyData(dataArray);
                
                const average = dataArray.reduce((a, b) => a + b) / dataArray.length;
                
                if (average > VOICE_THRESHOLD) {
                    console.log('Voice detected! Average:', average);
                    clearInterval(voiceDetectionInterval);
                    
                    if (isSpeaking) {
                        stopSpeaking();
                    }
                    
                    startRecording();
                }
            }, 100);
        }

        async function startRecording() {
            if (isListening) return;
            
            isListening = true;
            audioChunks = [];
            lastSpeechTime = Date.now();
            
            const voiceBtn = document.getElementById('voiceBtn');
            const waveform = document.getElementById('waveform');
            
            voiceBtn.classList.add('listening');
            waveform.classList.add('active');
            setStatus('üé§ Recording... (stops after 2s silence)');
            
            let options = { mimeType: "audio/webm" };
            if (!MediaRecorder.isTypeSupported("audio/webm")) {
                options = { mimeType: "audio/ogg" };
            }
            if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                options = {};
            }

            mediaRecorder = new MediaRecorder(audioStream, options);
            
            mediaRecorder.ondataavailable = (e) => {
                audioChunks.push(e.data);
            };

            mediaRecorder.onstop = async () => {
                const audioBlob = new Blob(audioChunks, { type: options.mimeType || 'audio/webm' });
                await processVoiceInput(audioBlob);
            };

            mediaRecorder.start();
            
            // Monitor for silence
            monitorSilence();
        }

        function monitorSilence() {
            const checkSilence = setInterval(() => {
                if (!isListening) {
                    clearInterval(checkSilence);
                    return;
                }
                
                const dataArray = new Uint8Array(analyser.frequencyBinCount);
                analyser.getByteFrequencyData(dataArray);
                const average = dataArray.reduce((a, b) => a + b) / dataArray.length;
                
                if (average > VOICE_THRESHOLD) {
                    lastSpeechTime = Date.now();
                } else if (Date.now() - lastSpeechTime > SILENCE_DURATION) {
                    console.log('Silence detected, stopping recording');
                    clearInterval(checkSilence);
                    stopRecording();
                }
            }, 100);
        }

        function stopRecording() {
            if (!isListening || !mediaRecorder) return;
            
            isListening = false;
            
            const voiceBtn = document.getElementById('voiceBtn');
            const waveform = document.getElementById('waveform');
            
            voiceBtn.classList.remove('listening');
            waveform.classList.remove('active');
            setStatus('‚è≥ Processing...');
            
            if (mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
        }

        async function processVoiceInput(audioBlob) {
            const formData = new FormData();
            formData.append("audio", audioBlob, "audio.webm");

            try {
                const response = await fetch("https://paricharika.onrender.com/asr", {
                    method: "POST",
                    body: formData
                });

                const data = await response.json();
                console.log("Transcript:", data);

                if (data.transcript && data.transcript.trim()) {
                    const transcript = data.transcript.trim();
                    document.getElementById("userInput").value = transcript;
                    addMessage(transcript, true);
                    
                    showThinking();
                    const aiResponse = await getAIResponse(transcript);
                    removeThinking();
                    addMessage(aiResponse);
                    
                    if (voiceModeActive) {
                        await speakText(aiResponse);
                    }
                } else {
                    setStatus("‚ùå Couldn't understand. Please speak again.");
                    if (voiceModeActive) {
                        setTimeout(() => startPassiveListening(), 1000);
                    }
                }
            } catch (error) {
                console.error('ASR Error:', error);
                setStatus("‚ùå Error processing audio");
                if (voiceModeActive) {
                    setTimeout(() => startPassiveListening(), 1000);
                }
            }
        }

        function confirmOrder() {
            if (currentOrder.length === 0) {
                alert('Koi order nahi hai! Pehle order karein.');
                return;
            }

            const total = currentOrder.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const orderId = 'ORD' + Date.now();
            
            const confirmMsg = `‚úÖ Order Confirmed!\nOrder ID: ${orderId}\nTotal: ‚Çπ${total}\n\nDhanyavaad! Aapka order 10-15 minute mein ready hoga. üôè`;
            addMessage(confirmMsg.replace(/\n/g, '<br>'));
            
            if (voiceModeActive) {
                stopVoiceMode();
            }
            
            speakText('Order confirm ho gaya. Dhanyavaad!');
            
            currentOrder = [];
            updateOrderSummary();
            setStatus('');
        }

        // Load ResponsiveVoice for better TTS
        const script = document.createElement('script');
        script.src = 'https://code.responsivevoice.org/responsivevoice.js?key=YOUR_KEY';
        script.onerror = () => {
            console.log('ResponsiveVoice not loaded, using browser TTS');
        };
        document.head.appendChild(script);

        window.onload = () => {
            console.log('Paricharika initialized');
        };
    </script>
</body>
</html>
